{% doc %}
  @prompt
    An auto-scrolling card carousel section. Each block is a new card. A card is made up of a portrait image, then underneath a copy section with a title and description left aligned. When hovering over the carousel it pauses the scrolling. When clicking on the carousel on mobile or desktop the user can drag to horizontally scroll through the card. 
{% enddoc %}
{% assign ai_gen_id = block.id | replace: '_', '' | downcase %}

{% style %}
  .ai-carousel-container-{{ ai_gen_id }} {
    width: 100%;
    overflow: hidden;
    position: relative;
    display: block;
  }

  .ai-carousel-wrapper-{{ ai_gen_id }} {
    display: flex;
    gap: {{ block.settings.card_gap }}px;
    cursor: grab;
    user-select: none;
    will-change: transform;
  }

  .ai-carousel-wrapper-{{ ai_gen_id }}.dragging {
    cursor: grabbing;
  }

  .ai-carousel-card-{{ ai_gen_id }} {
    flex: 0 0 {{ block.settings.card_width_mobile }}%;
    display: flex;
    flex-direction: column;
    gap: {{ block.settings.content_gap }}px;
  }

  @media screen and (min-width: 750px) {
    .ai-carousel-card-{{ ai_gen_id }} {
      flex: 0 0 {{ block.settings.card_width_desktop }}%;
    }
  }

  .ai-carousel-image-wrapper-{{ ai_gen_id }} {
    width: 100%;
    aspect-ratio: {{ block.settings.image_aspect_ratio }};
    overflow: hidden;
    border-radius: {{ block.settings.image_border_radius }}px;
    background-color: #f4f4f4;
  }

  .ai-carousel-image-{{ ai_gen_id }} {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .ai-carousel-image-wrapper-{{ ai_gen_id }} svg {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .ai-carousel-content-{{ ai_gen_id }} {
    text-align: left;
    display: flex;
    flex-direction: column;
    gap: {{ block.settings.text_gap }}px;
  }

  .ai-carousel-title-{{ ai_gen_id }} {
    font-size: {{ block.settings.title_size_mobile }}px;
    font-weight: {{ block.settings.title_weight }};
    color: {{ block.settings.title_color }};
    margin: 0;
    line-height: 1.2;
  }

  @media screen and (min-width: 750px) {
    .ai-carousel-title-{{ ai_gen_id }} {
      font-size: {{ block.settings.title_size_desktop }}px;
    }
  }

  .ai-carousel-description-{{ ai_gen_id }} {
    font-size: {{ block.settings.description_size_mobile }}px;
    color: {{ block.settings.description_color }};
    margin: 0;
    line-height: 1.5;
  }

  @media screen and (min-width: 750px) {
    .ai-carousel-description-{{ ai_gen_id }} {
      font-size: {{ block.settings.description_size_desktop }}px;
    }
  }
{% endstyle %}

<auto-scroll-carousel-{{ ai_gen_id }}
  class="ai-carousel-container-{{ ai_gen_id }}"
  data-scroll-speed="{{ block.settings.scroll_speed }}"
  {{ block.shopify_attributes }}
>
  <div class="ai-carousel-wrapper-{{ ai_gen_id }}">
    {% for i in (1..6) %}
      {% liquid
        assign image_key = 'card_' | append: i | append: '_image'
        assign title_key = 'card_' | append: i | append: '_title'
        assign description_key = 'card_' | append: i | append: '_description'
        
        assign card_image = block.settings[image_key]
        assign card_title = block.settings[title_key]
        assign card_description = block.settings[description_key]
      %}
      
      {% if card_image != blank or card_title != blank or card_description != blank %}
        <div class="ai-carousel-card-{{ ai_gen_id }}">
          <div class="ai-carousel-image-wrapper-{{ ai_gen_id }}">
            {% if card_image %}
              <img
                src="{{ card_image | image_url: width: 800 }}"
                alt="{{ card_image.alt | escape }}"
                loading="lazy"
                width="{{ card_image.width }}"
                height="{{ card_image.height }}"
                class="ai-carousel-image-{{ ai_gen_id }}"
              >
            {% else %}
              {{ 'image' | placeholder_svg_tag }}
            {% endif %}
          </div>
          <div class="ai-carousel-content-{{ ai_gen_id }}">
            {% if card_title != blank %}
              <h3 class="ai-carousel-title-{{ ai_gen_id }}">{{ card_title }}</h3>
            {% endif %}
            {% if card_description != blank %}
              <p class="ai-carousel-description-{{ ai_gen_id }}">{{ card_description }}</p>
            {% endif %}
          </div>
        </div>
      {% endif %}
    {% endfor %}
  </div>
</auto-scroll-carousel-{{ ai_gen_id }}>

<script>
  (function() {
    class AutoScrollCarousel{{ ai_gen_id }} extends HTMLElement {
      constructor() {
        super();
        this.wrapper = this.querySelector('.ai-carousel-wrapper-{{ ai_gen_id }}');
        this.scrollSpeed = parseFloat(this.dataset.scrollSpeed) || 1;
        this.isDragging = false;
        this.startX = 0;
        this.scrollLeft = 0;
        this.animationId = null;
        this.currentTranslate = 0;
        this.isPaused = false;
      }

      connectedCallback() {
        this.cloneCards();
        this.startAutoScroll();
        this.setupEventListeners();
      }

      disconnectedCallback() {
        this.stopAutoScroll();
      }

      cloneCards() {
        const cards = Array.from(this.wrapper.children);
        cards.forEach(card => {
          const clone = card.cloneNode(true);
          this.wrapper.appendChild(clone);
        });
      }

      startAutoScroll() {
        const scroll = () => {
          if (!this.isPaused && !this.isDragging) {
            this.currentTranslate -= this.scrollSpeed;
            const wrapperWidth = this.wrapper.scrollWidth / 2;
            
            if (Math.abs(this.currentTranslate) >= wrapperWidth) {
              this.currentTranslate = 0;
            }
            
            this.wrapper.style.transform = `translateX(${this.currentTranslate}px)`;
          }
          this.animationId = requestAnimationFrame(scroll);
        };
        this.animationId = requestAnimationFrame(scroll);
      }

      stopAutoScroll() {
        if (this.animationId) {
          cancelAnimationFrame(this.animationId);
        }
      }

      setupEventListeners() {
        this.addEventListener('mouseenter', () => {
          this.isPaused = true;
        });

        this.addEventListener('mouseleave', () => {
          this.isPaused = false;
        });

        this.wrapper.addEventListener('mousedown', (e) => {
          this.isDragging = true;
          this.startX = e.pageX;
          this.scrollLeft = this.currentTranslate;
          this.wrapper.classList.add('dragging');
        });

        this.wrapper.addEventListener('touchstart', (e) => {
          this.isDragging = true;
          this.startX = e.touches[0].pageX;
          this.scrollLeft = this.currentTranslate;
        });

        document.addEventListener('mousemove', (e) => {
          if (!this.isDragging) return;
          e.preventDefault();
          const x = e.pageX;
          const walk = (x - this.startX) * 2;
          this.currentTranslate = this.scrollLeft + walk;
          this.wrapper.style.transform = `translateX(${this.currentTranslate}px)`;
        });

        document.addEventListener('touchmove', (e) => {
          if (!this.isDragging) return;
          const x = e.touches[0].pageX;
          const walk = (x - this.startX) * 2;
          this.currentTranslate = this.scrollLeft + walk;
          this.wrapper.style.transform = `translateX(${this.currentTranslate}px)`;
        });

        document.addEventListener('mouseup', () => {
          this.isDragging = false;
          this.wrapper.classList.remove('dragging');
        });

        document.addEventListener('touchend', () => {
          this.isDragging = false;
        });
      }
    }

    customElements.define('auto-scroll-carousel-{{ ai_gen_id }}', AutoScrollCarousel{{ ai_gen_id }});
  })();
</script>

{% schema %}
{
  "name": "Auto-scroll carousel",
  "tag": null,
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Carousel settings"
    },
    {
      "type": "range",
      "id": "scroll_speed",
      "min": 0.5,
      "max": 5,
      "step": 0.5,
      "unit": "px",
      "label": "Scroll speed",
      "default": 1
    },
    {
      "type": "range",
      "id": "card_gap",
      "min": 0,
      "max": 50,
      "step": 5,
      "unit": "px",
      "label": "Gap between cards",
      "default": 20
    },
    {
      "type": "header",
      "content": "Card layout"
    },
    {
      "type": "range",
      "id": "card_width_mobile",
      "min": 60,
      "max": 100,
      "step": 5,
      "unit": "%",
      "label": "Card width on mobile",
      "default": 80
    },
    {
      "type": "range",
      "id": "card_width_desktop",
      "min": 15,
      "max": 50,
      "step": 5,
      "unit": "%",
      "label": "Card width on desktop",
      "default": 25
    },
    {
      "type": "range",
      "id": "content_gap",
      "min": 5,
      "max": 40,
      "step": 5,
      "unit": "px",
      "label": "Gap between image and text",
      "default": 15
    },
    {
      "type": "range",
      "id": "text_gap",
      "min": 5,
      "max": 30,
      "step": 5,
      "unit": "px",
      "label": "Gap between title and description",
      "default": 10
    },
    {
      "type": "header",
      "content": "Image"
    },
    {
      "type": "select",
      "id": "image_aspect_ratio",
      "label": "Aspect ratio",
      "options": [
        {
          "value": "3/4",
          "label": "Portrait (3:4)"
        },
        {
          "value": "2/3",
          "label": "Portrait (2:3)"
        },
        {
          "value": "4/5",
          "label": "Portrait (4:5)"
        },
        {
          "value": "1/1",
          "label": "Square (1:1)"
        }
      ],
      "default": "3/4"
    },
    {
      "type": "range",
      "id": "image_border_radius",
      "min": 0,
      "max": 30,
      "step": 2,
      "unit": "px",
      "label": "Border radius",
      "default": 14
    },
    {
      "type": "header",
      "content": "Title"
    },
    {
      "type": "range",
      "id": "title_size_mobile",
      "min": 14,
      "max": 30,
      "step": 2,
      "unit": "px",
      "label": "Size on mobile",
      "default": 18
    },
    {
      "type": "range",
      "id": "title_size_desktop",
      "min": 16,
      "max": 40,
      "step": 2,
      "unit": "px",
      "label": "Size on desktop",
      "default": 22
    },
    {
      "type": "select",
      "id": "title_weight",
      "label": "Weight",
      "options": [
        {
          "value": "400",
          "label": "Normal"
        },
        {
          "value": "500",
          "label": "Medium"
        },
        {
          "value": "600",
          "label": "Semi-bold"
        },
        {
          "value": "700",
          "label": "Bold"
        }
      ],
      "default": "600"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Color",
      "default": "#161513"
    },
    {
      "type": "header",
      "content": "Description"
    },
    {
      "type": "range",
      "id": "description_size_mobile",
      "min": 12,
      "max": 24,
      "step": 2,
      "unit": "px",
      "label": "Size on mobile",
      "default": 14
    },
    {
      "type": "range",
      "id": "description_size_desktop",
      "min": 14,
      "max": 28,
      "step": 2,
      "unit": "px",
      "label": "Size on desktop",
      "default": 16
    },
    {
      "type": "color",
      "id": "description_color",
      "label": "Color",
      "default": "#898580"
    },
    {
      "type": "header",
      "content": "Card 1"
    },
    {
      "type": "image_picker",
      "id": "card_1_image",
      "label": "Image"
    },
    {
      "type": "text",
      "id": "card_1_title",
      "label": "Title",
      "default": "Card title 1"
    },
    {
      "type": "textarea",
      "id": "card_1_description",
      "label": "Description",
      "default": "Add a description for this card"
    },
    {
      "type": "header",
      "content": "Card 2"
    },
    {
      "type": "image_picker",
      "id": "card_2_image",
      "label": "Image"
    },
    {
      "type": "text",
      "id": "card_2_title",
      "label": "Title",
      "default": "Card title 2"
    },
    {
      "type": "textarea",
      "id": "card_2_description",
      "label": "Description",
      "default": "Add a description for this card"
    },
    {
      "type": "header",
      "content": "Card 3"
    },
    {
      "type": "image_picker",
      "id": "card_3_image",
      "label": "Image"
    },
    {
      "type": "text",
      "id": "card_3_title",
      "label": "Title",
      "default": "Card title 3"
    },
    {
      "type": "textarea",
      "id": "card_3_description",
      "label": "Description",
      "default": "Add a description for this card"
    },
    {
      "type": "header",
      "content": "Card 4"
    },
    {
      "type": "image_picker",
      "id": "card_4_image",
      "label": "Image"
    },
    {
      "type": "text",
      "id": "card_4_title",
      "label": "Title",
      "default": "Card title 4"
    },
    {
      "type": "textarea",
      "id": "card_4_description",
      "label": "Description",
      "default": "Add a description for this card"
    },
    {
      "type": "header",
      "content": "Card 5"
    },
    {
      "type": "image_picker",
      "id": "card_5_image",
      "label": "Image"
    },
    {
      "type": "text",
      "id": "card_5_title",
      "label": "Title",
      "default": "Card title 5"
    },
    {
      "type": "textarea",
      "id": "card_5_description",
      "label": "Description",
      "default": "Add a description for this card"
    },
    {
      "type": "header",
      "content": "Card 6"
    },
    {
      "type": "image_picker",
      "id": "card_6_image",
      "label": "Image"
    },
    {
      "type": "text",
      "id": "card_6_title",
      "label": "Title",
      "default": "Card title 6"
    },
    {
      "type": "textarea",
      "id": "card_6_description",
      "label": "Description",
      "default": "Add a description for this card"
    }
  ],
  "presets": [
    {
      "name": "Auto-scroll carousel"
    }
  ]
}
{% endschema %}
