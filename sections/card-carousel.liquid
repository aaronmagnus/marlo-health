{%- comment -%}
  Card Carousel Section
  - Horizontal scrolling cards with infinite loop
  - Portrait image cards with content below or overlaid
  - Navigation arrows and drag-to-scroll support
{%- endcomment -%}

{{ 'swiper.css' | asset_url | stylesheet_tag }}

{%- assign section_bg_rgb = section.settings.background_color | color_to_rgb -%}

<style>
  [data-section-id="{{ section.id }}"] {
    {% if section_bg_rgb != 'rgba(0, 0, 0, 0.0)' %}
      --card-carousel-bg: {{ section.settings.background_color }};
    {% else %}
      --card-carousel-bg: transparent;
    {% endif %}
    --card-carousel-padding-top: {{ section.settings.padding_top }}px;
    --card-carousel-padding-bottom: {{ section.settings.padding_bottom }}px;
    --card-carousel-radius: {{ section.settings.card_radius }}px;
    --card-carousel-gap: {{ section.settings.gap }}px;
  }

  [data-section-id="{{ section.id }}"].card-carousel {
    background-color: var(--card-carousel-bg);
    padding-top: var(--card-carousel-padding-top);
    padding-bottom: var(--card-carousel-padding-bottom);
  }

  [data-section-id="{{ section.id }}"] .card-carousel__inner {
    max-width: none;
    padding-left: 1.5rem;
    padding-right: 1.5rem;
  }

  [data-section-id="{{ section.id }}"] .swiper-slide {
    width: {{ section.settings.card_width }}px;
  }

  {% if section.settings.content_overlay %}
    /* Overlay mode - content on top of image */
    [data-section-id="{{ section.id }}"] .card-carousel__card {
      position: relative;
      aspect-ratio: 3 / 4;
      border-radius: var(--card-carousel-radius);
      overflow: hidden;
      background-color: #f0f0f0;
    }

    [data-section-id="{{ section.id }}"] .card-carousel__image-wrapper {
      position: absolute;
      inset: 0;
    }

    [data-section-id="{{ section.id }}"] .card-carousel__image {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    [data-section-id="{{ section.id }}"] .card-carousel__content {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
  {% else %}
    /* Below mode - content below image */
    [data-section-id="{{ section.id }}"] .card-carousel__card {
      display: flex;
      flex-direction: column;
      border-radius: var(--card-carousel-radius);
      overflow: hidden;
      background-color: #f0f0f0;
    }

    [data-section-id="{{ section.id }}"] .card-carousel__image-wrapper {
      position: relative;
      aspect-ratio: 3 / 4;
    }

    [data-section-id="{{ section.id }}"] .card-carousel__image {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    [data-section-id="{{ section.id }}"] .card-carousel__content {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      min-height: 120px;
    }
  {% endif %}

  [data-section-id="{{ section.id }}"] .card-carousel__title {
    font-size: {{ section.settings.title_font_size }}rem;
    font-weight: 600;
    line-height: 1.2;
    margin: 0;
  }

  [data-section-id="{{ section.id }}"] .card-carousel__description {
    font-size: {{ section.settings.description_font_size }}rem;
    line-height: 1.5;
    margin: 0;
    opacity: 0.9;
  }

  [data-section-id="{{ section.id }}"] .card-carousel__nav {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    margin-top: 1.5rem;
    padding: 0 1.5rem;
    max-width: var(--site-max-width);
    margin-left: auto;
    margin-right: auto;
  }

  [data-section-id="{{ section.id }}"] .card-carousel__nav-btn {
    position: static;
    width: auto;
    height: auto;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    border-radius: 0;
    background: transparent;
    color: {{ section.settings.arrow_color }};
    cursor: pointer;
    transition: opacity 0.2s ease;
  }

  [data-section-id="{{ section.id }}"] .card-carousel__nav-btn:hover {
    opacity: 0.7;
  }

  [data-section-id="{{ section.id }}"] .card-carousel__nav-btn.swiper-button-disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  [data-section-id="{{ section.id }}"] .card-carousel__nav-btn::after {
    display: none;
  }

  /* CSS-only arrow icons */
  [data-section-id="{{ section.id }}"] .card-carousel__arrow {
    display: grid;
    place-items: center;
  }

  [data-section-id="{{ section.id }}"] .card-carousel__arrow::before {
    content: "";
    width: 14px;
    height: 14px;
    border-style: solid;
    border-width: 0 3px 3px 0;
    border-color: currentColor;
    transform: rotate(-45deg);
    margin-left: -4px;
  }

  [data-section-id="{{ section.id }}"] .card-carousel__nav-prev .card-carousel__arrow::before {
    border-width: 3px 0 0 3px;
    margin-left: 4px;
    margin-right: 0;
  }

  /* Section header styles */
  [data-section-id="{{ section.id }}"] .card-carousel__header {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    margin-bottom: 3rem;
    padding: 0 1.5rem;
    max-width: var(--site-max-width);
    margin-left: auto;
    margin-right: auto;
  }

  [data-section-id="{{ section.id }}"] .card-carousel__section-title {
    font-size: 2.8rem;
    font-weight: 600;
    line-height: 1.15;
    margin: 0;
    color: {{ section.settings.title_color }};
    max-width: 600px;
  }

  [data-section-id="{{ section.id }}"] .card-carousel__header-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }

  [data-section-id="{{ section.id }}"] .card-carousel__header-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 1.4rem 2.4rem;
    font-size: 1.6rem;
    font-weight: 500;
    text-decoration: none;
    border-radius: 50px;
    transition: opacity 0.2s ease, background-color 0.2s ease;
    border: 2px solid {{ section.settings.button_color }};
    background-color: transparent;
    color: {{ section.settings.button_color }};
  }

  [data-section-id="{{ section.id }}"] .card-carousel__header-btn:hover {
    opacity: 0.8;
  }

  [data-section-id="{{ section.id }}"] .card-carousel__header-btn--filled {
    background-color: {{ section.settings.button_color }};
    color: {{ section.settings.button_text_color }};
  }

  /* Desktop header layout */
  @media (min-width: 900px) {
    [data-section-id="{{ section.id }}"] .card-carousel__header {
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      gap: 3rem;
    }

    [data-section-id="{{ section.id }}"] .card-carousel__section-title {
      font-size: 4rem;
      flex: 1;
    }

    [data-section-id="{{ section.id }}"] .card-carousel__header-buttons {
      flex-shrink: 0;
    }
  }

  /* Large desktop - align header and nav with max-width */
  @media (min-width: 1200px) {
    [data-section-id="{{ section.id }}"] .card-carousel__header,
    [data-section-id="{{ section.id }}"] .card-carousel__nav {
      padding-left: max(1.5rem, calc((100vw - var(--site-max-width)) / 2 + 1.5rem));
      padding-right: max(1.5rem, calc((100vw - var(--site-max-width)) / 2 + 1.5rem));
    }
  }

  /* Block-level styles for content */
  {% for block in section.blocks %}
    {% case block.type %}
      {% when 'card' %}
        [data-block-id="{{ block.id }}"] .card-carousel__content {
          {% if section.settings.content_overlay %}
            background: {{ block.settings.content_background | color_modify: 'alpha', 0.85 }};
            backdrop-filter: blur({{ section.settings.blur_amount }}px);
            -webkit-backdrop-filter: blur({{ section.settings.blur_amount }}px);
          {% else %}
            background: {{ block.settings.content_background }};
          {% endif %}
          color: {{ block.settings.text_color }};
        }
    {% endcase %}
  {% endfor %}
</style>

<script type="module" src="{{ 'slider.js' | asset_url }}" defer="defer"></script>

<div data-section-id="{{ section.id }}" class="card-carousel">
  <div class="card-carousel__inner">
    {% if section.settings.section_title != blank or section.settings.button_1_text != blank or section.settings.button_2_text != blank %}
      <div class="card-carousel__header">
        {% if section.settings.section_title != blank %}
          <h2 class="card-carousel__section-title">{{ section.settings.section_title }}</h2>
        {% endif %}
        {% if section.settings.button_1_text != blank or section.settings.button_2_text != blank %}
          <div class="card-carousel__header-buttons">
            {% if section.settings.button_1_text != blank %}
              <a
                class="card-carousel__header-btn"
                {% if section.settings.button_1_link != blank %}href="{{ section.settings.button_1_link }}"{% endif %}
              >
                {{ section.settings.button_1_text }}
              </a>
            {% endif %}
            {% if section.settings.button_2_text != blank %}
              <a
                class="card-carousel__header-btn card-carousel__header-btn--filled"
                {% if section.settings.button_2_link != blank %}href="{{ section.settings.button_2_link }}"{% endif %}
              >
                {{ section.settings.button_2_text }}
              </a>
            {% endif %}
          </div>
        {% endif %}
      </div>
    {% endif %}

    {% if section.blocks.size == 0 %}
      <p style="text-align: center; padding: 2rem; color: #666;">Add card blocks using the theme editor</p>
    {% else %}
      <slideshow-section class="card-carousel__slider">
        <div data-swiper class="swiper">
          <div data-swiper-container class="swiper-wrapper">
            {% for block in section.blocks %}
              {% case block.type %}
                {% when 'card' %}
                  <div
                    data-swiper-slide
                    class="swiper-slide"
                    data-block-id="{{ block.id }}"
                    {{ block.shopify_attributes }}
                  >
                    <div class="card-carousel__card">
                      <div class="card-carousel__image-wrapper">
                        {% if block.settings.image != blank %}
                          <img
                            class="card-carousel__image"
                            src="{{ block.settings.image | image_url: width: 600 }}"
                            srcset="
                              {{ block.settings.image | image_url: width: 400 }} 400w,
                              {{ block.settings.image | image_url: width: 600 }} 600w,
                              {{ block.settings.image | image_url: width: 800 }} 800w
                            "
                            sizes="(max-width: 600px) 80vw, (max-width: 900px) 45vw, 25vw"
                            alt="{{ block.settings.image.alt | escape }}"
                            loading="lazy"
                            width="{{ block.settings.image.width }}"
                            height="{{ block.settings.image.height }}"
                          >
                        {% else %}
                          {{ 'image' | placeholder_svg_tag: 'card-carousel__image placeholder-svg' }}
                        {% endif %}
                      </div>
                      <div class="card-carousel__content">
                        {% if block.settings.title != blank %}
                          <h3 class="card-carousel__title">{{ block.settings.title }}</h3>
                        {% endif %}
                        {% if block.settings.description != blank %}
                          <p class="card-carousel__description">{{ block.settings.description }}</p>
                        {% endif %}
                      </div>
                    </div>
                  </div>
              {% endcase %}
            {% endfor %}
          </div>
        </div>

        <div class="card-carousel__nav">
          <button class="card-carousel__nav-btn card-carousel__nav-prev swiper-button-prev" aria-label="Previous slide">
            <span class="card-carousel__arrow"></span>
          </button>
          <button class="card-carousel__nav-btn card-carousel__nav-next swiper-button-next" aria-label="Next slide">
            <span class="card-carousel__arrow"></span>
          </button>
        </div>

        <script data-swiper-configuration type="text/json">
          {
            "slidesPerView": "auto",
            "spaceBetween": {{ section.settings.gap }},
            "grabCursor": true,
            "enableOnMedia": "(min-width: 0px)",
            {% if section.blocks.size > 1 %}
              "loop": true,
            {% endif %}
            "navigation": {
              "nextEl": ".card-carousel__nav-next",
              "prevEl": ".card-carousel__nav-prev"
            }
          }
        </script>
      </slideshow-section>
    {% endif %}
  </div>
</div>

{% schema %}
{
  "name": "MH Card Carousel",
  "tag": "section",
  "class": "card-carousel-section",
  "settings": [
    {
      "type": "header",
      "content": "Section Header"
    },
    {
      "type": "text",
      "id": "section_title",
      "label": "Section title"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title color",
      "default": "#ffffff"
    },
    {
      "type": "text",
      "id": "button_1_text",
      "label": "Button 1 text"
    },
    {
      "type": "url",
      "id": "button_1_link",
      "label": "Button 1 link"
    },
    {
      "type": "text",
      "id": "button_2_text",
      "label": "Button 2 text"
    },
    {
      "type": "url",
      "id": "button_2_link",
      "label": "Button 2 link"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button 2 text color",
      "default": "#1a1a1a",
      "info": "Only applies to filled button (Button 2)"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "card_width",
      "label": "Card width",
      "min": 200,
      "max": 400,
      "step": 10,
      "default": 280,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "gap",
      "label": "Gap between cards",
      "min": 8,
      "max": 48,
      "step": 4,
      "default": 24,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "card_radius",
      "label": "Card border radius",
      "min": 0,
      "max": 32,
      "step": 2,
      "default": 12,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "blur_amount",
      "label": "Content blur amount",
      "min": 0,
      "max": 20,
      "step": 2,
      "default": 10,
      "unit": "px"
    },
    {
      "type": "checkbox",
      "id": "content_overlay",
      "label": "Overlay content on image",
      "default": false,
      "info": "When enabled, content sits on top of the image instead of below"
    },
    {
      "type": "header",
      "content": "Typography"
    },
    {
      "type": "range",
      "id": "title_font_size",
      "label": "Title font size",
      "min": 1,
      "max": 3,
      "step": 0.1,
      "default": 1.5,
      "unit": "rem"
    },
    {
      "type": "range",
      "id": "description_font_size",
      "label": "Description font size",
      "min": 0.8,
      "max": 1.5,
      "step": 0.1,
      "default": 0.9,
      "unit": "rem"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Section background",
      "default": "transparent"
    },
    {
      "type": "color",
      "id": "arrow_color",
      "label": "Arrow color",
      "default": "#333333"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 60,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 60,
      "unit": "px"
    }
  ],
  "blocks": [
    {
      "type": "card",
      "name": "Card",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Card title"
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Description",
          "default": "Add a short description for this card."
        },
        {
          "type": "header",
          "content": "Content styling"
        },
        {
          "type": "color",
          "id": "content_background",
          "label": "Content background",
          "default": "#1a1a1a"
        },
        {
          "type": "color",
          "id": "text_color",
          "label": "Text color",
          "default": "#ffffff"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "MH Card Carousel",
      "blocks": [
        {
          "type": "card",
          "settings": {
            "title": "Sustained energy",
            "description": "B vitamins support energy and focus without the caffeine crash.",
            "content_background": "#1a1a1a",
            "text_color": "#ffffff"
          }
        },
        {
          "type": "card",
          "settings": {
            "title": "Immune defence",
            "description": "Vitamin C from citrus fruits and minerals like zinc support your immune function.",
            "content_background": "#1a1a1a",
            "text_color": "#ffffff"
          }
        },
        {
          "type": "card",
          "settings": {
            "title": "Regular digestion",
            "description": "Calcium supports digestive enzymes, biotin helps maintain the gut lining.",
            "content_background": "#1a1a1a",
            "text_color": "#ffffff"
          }
        },
        {
          "type": "card",
          "settings": {
            "title": "Stress management",
            "description": "B vitamins support stress management, resilience and the nervous system.",
            "content_background": "#1a1a1a",
            "text_color": "#ffffff"
          }
        }
      ]
    }
  ]
}
{% endschema %}
